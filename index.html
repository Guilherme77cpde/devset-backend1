<!doctype html>
<html lang="pt-BR">
  <head>
      <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Devset IA</title>
                  <style>
                        body { font-family: Arial, sans-serif; max-width: 760px; margin: 24px auto; padding: 0 12px; }
                              textarea { width: 100%; min-height: 80px; }
                                    .row { display: flex; gap: 12px; align-items: center; margin: 10px 0; }
                                          button { padding: 8px 14px; cursor: pointer; }
                                                #chat { border: 1px solid #ddd; border-radius: 8px; padding: 12px; min-height: 140px; }
                                                      .msg { margin: 8px 0; white-space: pre-wrap; }
                                                            .user { color: #1b4fff; }
                                                                  .bot { color: #111; }
                                                                        #error { color: #c1121f; margin-top: 10px; }
                                                                            </style>
                                                                              </head>
                                                                                <body>
                                                                                    <h1>Devset IA</h1>
                                                                                    
                                                                                        <label for="message">Mensagem</label>
                                                                                            <textarea id="message" placeholder="Digite sua mensagem..."></textarea>
                                                                                            
                                                                                                <div class="row">
                                                                                                      <label>
                                                                                                              <input type="checkbox" id="streamMode" checked />
                                                                                                                      Modo: Stream (SSE)
                                                                                                                            </label>
                                                                                                                                  <button id="sendBtn">Enviar</button>
                                                                                                                                      </div>
                                                                                                                                      
                                                                                                                                          <div id="chat"></div>
                                                                                                                                              <div id="error"></div>
                                                                                                                                              
                                                                                                                                                  <script>
                                                                                                                                                        const API_BASE = "https://devset-backend1-production.up.railway.app";
                                                                                                                                                              const messageEl = document.getElementById("message");
                                                                                                                                                                    const streamEl = document.getElementById("streamMode");
                                                                                                                                                                          const chatEl = document.getElementById("chat");
                                                                                                                                                                                const errorEl = document.getElementById("error");
                                                                                                                                                                                
                                                                                                                                                                                      function addMessage(role, text) {
                                                                                                                                                                                              const div = document.createElement("div");
                                                                                                                                                                                                      div.className = `msg ${role}`;
                                                                                                                                                                                                              div.textContent = `${role === "user" ? "VocÃª" : "Bot"}: ${text}`;
                                                                                                                                                                                                                      chatEl.appendChild(div);
                                                                                                                                                                                                                              return div;
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          async function sendNormal(message) {
                                                                                                                                                                                                                                                  const res = await fetch(`${API_BASE}/chat`, {
                                                                                                                                                                                                                                                            method: "POST",
                                                                                                                                                                                                                                                                      headers: { "Content-Type": "application/json" },
                                                                                                                                                                                                                                                                                body: JSON.stringify({ message })
                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);
                                                                                                                                                                                                                                                                                                        const data = await res.json();
                                                                                                                                                                                                                                                                                                                addMessage("bot", data.reply || "Sem resposta");
                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                            async function sendStream(message) {
                                                                                                                                                                                                                                                                                                                                    const res = await fetch(`${API_BASE}/chat_stream`, {
                                                                                                                                                                                                                                                                                                                                              method: "POST",
                                                                                                                                                                                                                                                                                                                                                        headers: { "Content-Type": "application/json" },
                                                                                                                                                                                                                                                                                                                                                                  body: JSON.stringify({ message })
                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                  if (!res.ok || !res.body) throw new Error(`Erro HTTP ${res.status}`);
                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                          const botLine = addMessage("bot", "");
                                                                                                                                                                                                                                                                                                                                                                                                  const reader = res.body.getReader();
                                                                                                                                                                                                                                                                                                                                                                                                          const decoder = new TextDecoder();
                                                                                                                                                                                                                                                                                                                                                                                                                  let buffer = "";
                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                          while (true) {
                                                                                                                                                                                                                                                                                                                                                                                                                                    const { value, done } = await reader.read();
                                                                                                                                                                                                                                                                                                                                                                                                                                              if (done) break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        buffer += decoder.decode(value, { stream: true });
                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const events = buffer.split("\n\n");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            buffer = events.pop() || "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      for (const block of events) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const lines = block.split("\n");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const eventLine = lines.find(l => l.startsWith("event:"));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const dataLine = lines.find(l => l.startsWith("data:"));''
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!eventLine || !dataLine) continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const event = eventLine.replace("event:", "").trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const data = dataLine.replace("data:", "").trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (event === "token") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const current = botLine.textContent.replace(/^Bot:\s?/, "");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      botLine.textContent = `Bot: ${current}${data}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (event === "done") return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById("sendBtn").addEventListener("click", async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    errorEl.textContent = "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const message = messageEl.value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!message) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              errorEl.textContent = "Digite uma mensagem antes de enviar.";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        addMessage("user", message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                messageEl.value = "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (streamEl.checked) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await sendStream(message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sendNormal(message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                errorEl.textContent = `Falha de rede/API: ${err.message}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >